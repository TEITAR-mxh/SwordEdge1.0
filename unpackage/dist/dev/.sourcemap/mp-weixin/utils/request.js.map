{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["/**\n * uni-app 网络请求封装\n * 基于 uni.request API，支持拦截器、错误处理、Token 管理\n */\n\n// 基础配置\nconst BASE_URL = process.env.NODE_ENV === 'development'\n  ? 'http://localhost:5001'  // 开发环境（匹配 app.py 的端口）\n  : 'https://api.swordedge.com' // 生产环境\n\nconst TIMEOUT = 30000 // 请求超时时间（毫秒）\n\n/**\n * 请求拦截器 - 添加 Token、自定义 Header\n */\nconst requestInterceptor = (config) => {\n  // 添加 Token\n  const token = uni.getStorageSync('token')\n  if (token) {\n    config.header = {\n      ...config.header,\n      'Authorization': `Bearer ${token}`\n    }\n  }\n\n  // 添加通用 Header\n  config.header = {\n    'Content-Type': 'application/json',\n    ...config.header\n  }\n\n  console.log(`[Request] ${config.method} ${config.url}`, config.data || config.params)\n  return config\n}\n\n/**\n * 响应拦截器 - 统一处理错误\n */\nconst responseInterceptor = (response) => {\n  const { statusCode, data } = response\n\n  // HTTP 状态码处理\n  if (statusCode === 200 || statusCode === 201 || statusCode === 202) {\n    console.log(`[Response] Success`, data)\n    return data\n  }\n\n  // 错误处理\n  const errorMsg = handleErrorStatus(statusCode, data)\n  console.error(`[Response] Error ${statusCode}:`, errorMsg)\n\n  uni.showToast({\n    title: errorMsg,\n    icon: 'none',\n    duration: 2000\n  })\n\n  return Promise.reject(new Error(errorMsg))\n}\n\n/**\n * HTTP 状态码错误处理\n */\nconst handleErrorStatus = (statusCode, data) => {\n  const errorMap = {\n    400: '请求参数错误',\n    401: '未授权，请重新登录',\n    403: '拒绝访问',\n    404: '请求资源不存在',\n    408: '请求超时',\n    500: '服务器内部错误',\n    501: '服务未实现',\n    502: '网关错误',\n    503: '服务不可用',\n    504: '网关超时',\n    505: 'HTTP 版本不受支持'\n  }\n\n  // 401 未授权，跳转登录页\n  if (statusCode === 401) {\n    uni.removeStorageSync('token')\n    uni.removeStorageSync('userInfo')\n    uni.redirectTo({ url: '/pages/login/login' })\n  }\n\n  return data?.message || errorMap[statusCode] || `请求失败 (${statusCode})`\n}\n\n/**\n * 核心请求方法\n */\nconst request = (config) => {\n  // 应用拦截器\n  config = requestInterceptor({\n    url: BASE_URL + config.url,\n    method: config.method || 'GET',\n    timeout: config.timeout || TIMEOUT,\n    header: config.header || {},\n    data: config.data,\n    dataType: config.dataType || 'json',\n    responseType: config.responseType || 'text'\n  })\n\n  return new Promise((resolve, reject) => {\n    uni.request({\n      ...config,\n      success: (res) => {\n        try {\n          const result = responseInterceptor(res)\n          resolve(result)\n        } catch (error) {\n          reject(error)\n        }\n      },\n      fail: (err) => {\n        console.error('[Request] Network Error:', err)\n\n        let errorMsg = '网络连接失败'\n        if (err.errMsg) {\n          if (err.errMsg.includes('timeout')) {\n            errorMsg = '请求超时，请检查网络'\n          } else if (err.errMsg.includes('fail')) {\n            errorMsg = '网络请求失败'\n          }\n        }\n\n        uni.showToast({\n          title: errorMsg,\n          icon: 'none',\n          duration: 2000\n        })\n\n        reject(new Error(errorMsg))\n      }\n    })\n  })\n}\n\n/**\n * GET 请求\n */\nexport const get = (url, params = {}, config = {}) => {\n  return request({\n    url,\n    method: 'GET',\n    data: params,\n    ...config\n  })\n}\n\n/**\n * POST 请求\n */\nexport const post = (url, data = {}, config = {}) => {\n  return request({\n    url,\n    method: 'POST',\n    data,\n    ...config\n  })\n}\n\n/**\n * PUT 请求\n */\nexport const put = (url, data = {}, config = {}) => {\n  return request({\n    url,\n    method: 'PUT',\n    data,\n    ...config\n  })\n}\n\n/**\n * DELETE 请求\n */\nexport const del = (url, data = {}, config = {}) => {\n  return request({\n    url,\n    method: 'DELETE',\n    data,\n    ...config\n  })\n}\n\n/**\n * 文件上传（支持进度回调）\n * @param {String} url - 上传地址\n * @param {String} filePath - 本地文件路径\n * @param {Object} formData - 额外表单数据\n * @param {Function} onProgress - 进度回调 (progress) => {}\n */\nexport const uploadFile = (url, filePath, formData = {}, onProgress = null) => {\n  const token = uni.getStorageSync('token')\n\n  return new Promise((resolve, reject) => {\n    const uploadTask = uni.uploadFile({\n      url: BASE_URL + url,\n      filePath,\n      name: 'video', // 后端接收字段名\n      formData,\n      header: {\n        'Authorization': token ? `Bearer ${token}` : ''\n      },\n      success: (res) => {\n        if (res.statusCode === 200 || res.statusCode === 202) {\n          const data = JSON.parse(res.data)\n          console.log('[Upload] Success:', data)\n          resolve(data)\n        } else {\n          const errorMsg = `上传失败 (${res.statusCode})`\n          console.error('[Upload] Error:', errorMsg)\n          uni.showToast({ title: errorMsg, icon: 'none' })\n          reject(new Error(errorMsg))\n        }\n      },\n      fail: (err) => {\n        console.error('[Upload] Network Error:', err)\n        uni.showToast({ title: '上传失败', icon: 'none' })\n        reject(err)\n      }\n    })\n\n    // 监听上传进度\n    if (onProgress && typeof onProgress === 'function') {\n      uploadTask.onProgressUpdate((res) => {\n        onProgress(res.progress) // 0-100\n      })\n    }\n  })\n}\n\n/**\n * 文件下载（支持进度回调）\n */\nexport const downloadFile = (url, onProgress = null) => {\n  const token = uni.getStorageSync('token')\n\n  return new Promise((resolve, reject) => {\n    const downloadTask = uni.downloadFile({\n      url: BASE_URL + url,\n      header: {\n        'Authorization': token ? `Bearer ${token}` : ''\n      },\n      success: (res) => {\n        if (res.statusCode === 200) {\n          console.log('[Download] Success:', res.tempFilePath)\n          resolve(res.tempFilePath)\n        } else {\n          const errorMsg = `下载失败 (${res.statusCode})`\n          console.error('[Download] Error:', errorMsg)\n          uni.showToast({ title: errorMsg, icon: 'none' })\n          reject(new Error(errorMsg))\n        }\n      },\n      fail: (err) => {\n        console.error('[Download] Network Error:', err)\n        uni.showToast({ title: '下载失败', icon: 'none' })\n        reject(err)\n      }\n    })\n\n    // 监听下载进度\n    if (onProgress && typeof onProgress === 'function') {\n      downloadTask.onProgressUpdate((res) => {\n        onProgress(res.progress) // 0-100\n      })\n    }\n  })\n}\n\n/**\n * WebSocket 连接管理\n */\nclass WebSocketClient {\n  constructor(url) {\n    this.url = BASE_URL.replace('http', 'ws') + url\n    this.socket = null\n    this.isConnected = false\n    this.reconnectTimer = null\n    this.reconnectAttempts = 0\n    this.maxReconnectAttempts = 5\n    this.messageHandlers = []\n  }\n\n  // 连接 WebSocket\n  connect() {\n    return new Promise((resolve, reject) => {\n      this.socket = uni.connectSocket({\n        url: this.url,\n        success: () => {\n          console.log('[WebSocket] Connecting...')\n        },\n        fail: (err) => {\n          console.error('[WebSocket] Connection Failed:', err)\n          reject(err)\n        }\n      })\n\n      this.socket.onOpen(() => {\n        console.log('[WebSocket] Connected')\n        this.isConnected = true\n        this.reconnectAttempts = 0\n        resolve()\n      })\n\n      this.socket.onMessage((res) => {\n        const data = JSON.parse(res.data)\n        console.log('[WebSocket] Message:', data)\n        this.messageHandlers.forEach(handler => handler(data))\n      })\n\n      this.socket.onClose(() => {\n        console.log('[WebSocket] Closed')\n        this.isConnected = false\n        this.reconnect()\n      })\n\n      this.socket.onError((err) => {\n        console.error('[WebSocket] Error:', err)\n        this.isConnected = false\n      })\n    })\n  }\n\n  // 发送消息\n  send(data) {\n    if (this.isConnected) {\n      this.socket.send({\n        data: JSON.stringify(data),\n        success: () => {\n          console.log('[WebSocket] Sent:', data)\n        },\n        fail: (err) => {\n          console.error('[WebSocket] Send Failed:', err)\n        }\n      })\n    } else {\n      console.warn('[WebSocket] Not connected, cannot send message')\n    }\n  }\n\n  // 监听消息\n  onMessage(handler) {\n    this.messageHandlers.push(handler)\n  }\n\n  // 断开连接\n  close() {\n    if (this.socket) {\n      this.socket.close()\n      this.isConnected = false\n      clearTimeout(this.reconnectTimer)\n    }\n  }\n\n  // 自动重连\n  reconnect() {\n    if (this.reconnectAttempts < this.maxReconnectAttempts) {\n      this.reconnectAttempts++\n      console.log(`[WebSocket] Reconnecting... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`)\n\n      this.reconnectTimer = setTimeout(() => {\n        this.connect()\n      }, 3000)\n    } else {\n      console.error('[WebSocket] Max reconnect attempts reached')\n    }\n  }\n}\n\nexport const createWebSocket = (url) => {\n  return new WebSocketClient(url)\n}\n\n// 默认导出\nexport default {\n  get,\n  post,\n  put,\n  del,\n  uploadFile,\n  downloadFile,\n  createWebSocket\n}\n"],"names":["uni"],"mappings":"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"}