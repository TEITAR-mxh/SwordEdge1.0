# 后端服务部署指南

## 一、部署后端服务到公网

### 1. 选择云服务器
- 推荐使用阿里云、腾讯云或AWS等云服务提供商
- 选择合适的配置（建议至少2核4G内存，支持GPU的实例更佳）
- 操作系统选择Ubuntu 20.04 LTS或CentOS 7/8

### 2. 服务器环境配置

#### 2.1 安装Python和依赖
```bash
# 更新系统
apt update && apt upgrade -y

# 安装Python 3.9
apt install python3.9 python3.9-dev python3-pip -y

# 安装虚拟环境
apt install python3-venv -y

# 安装FFmpeg（用于视频处理）
apt install ffmpeg -y
```

#### 2.2 安装项目依赖
```bash
# 创建项目目录
mkdir -p /opt/swordedge
cd /opt/swordedge

# 克隆项目代码（假设使用GitHub）
git clone https://github.com/your-username/swordedge.git .

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装项目依赖
cd backend
pip install -r requirements.txt
```

### 3. 配置Gunicorn

#### 3.1 安装Gunicorn
```bash
pip install gunicorn
```

#### 3.2 创建Gunicorn配置文件
```bash
cat > gunicorn_config.py << EOF
bind = '0.0.0.0:5001'
workers = 4
worker_class = 'sync'
timeout = 300
accesslog = '/var/log/swordedge/access.log'
errorlog = '/var/log/swordedge/error.log'
loglevel = 'info'
EOF
```

#### 3.3 创建日志目录
```bash
mkdir -p /var/log/swordedge
```

### 4. 配置Systemd服务

#### 4.1 创建Systemd服务文件
```bash
cat > /etc/systemd/system/swordedge.service << EOF
[Unit]
Description=SwordEdge Backend Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/swordedge/backend
ExecStart=/opt/swordedge/venv/bin/gunicorn -c gunicorn_config.py app:app
Restart=always
RestartSec=10
Environment=FLASK_CONFIG=production

[Install]
WantedBy=multi-user.target
EOF
```

#### 4.2 启动服务
```bash
# 重新加载Systemd配置
systemctl daemon-reload

# 启动服务
systemctl start swordedge

# 设置开机自启
systemctl enable swordedge

# 查看服务状态
systemctl status swordedge
```

## 二、配置域名和SSL

### 1. 购买域名
- 在阿里云域名、腾讯云域名等服务商购买域名
- 例如：swordedge.com

### 2. 配置DNS解析
- 登录域名管理控制台
- 添加A记录，将域名解析到服务器的公网IP
- 例如：
  - 主机记录：@
  - 记录类型：A
  - 记录值：服务器公网IP
  - TTL：10分钟

### 3. 安装Nginx
```bash
apt install nginx -y
```

### 4. 配置Nginx反向代理

#### 4.1 创建Nginx配置文件
```bash
cat > /etc/nginx/sites-available/swordedge << EOF
server {
    listen 80;
    server_name swordedge.com www.swordedge.com;

    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF
```

#### 4.2 启用配置
```bash
ln -s /etc/nginx/sites-available/swordedge /etc/nginx/sites-enabled/

# 检查配置
nginx -t

# 重启Nginx
systemctl restart nginx
```

### 5. 配置SSL证书

#### 5.1 使用Let's Encrypt
```bash
# 安装Certbot
apt install certbot python3-certbot-nginx -y

# 获取SSL证书
certbot --nginx -d swordedge.com -d www.swordedge.com

# 配置自动续期
certbot renew --dry-run
```

#### 5.2 验证SSL配置
访问 `https://swordedge.com`，检查SSL证书是否正常

## 三、在APP中调用后端API

### 1. 修改前端配置

#### 1.1 修改BASE_URL
编辑 `utils/request.js` 文件，修改BASE_URL为你的域名：

```javascript
const BASE_URL = process.env.NODE_ENV === 'development'
  ? 'http://localhost:5001'  // 开发环境
  : 'https://swordedge.com' // 生产环境
```

#### 1.2 构建生产版本
```bash
npm run build:h5
```

### 2. APP调用配置

#### 2.1 配置网络权限
在APP的配置文件中添加网络权限：

- **uni-app**：在 `manifest.json` 中添加：
  ```json
  "h5": {
    "devServer": {
      "https": false
    }
  }
  ```

- **微信小程序**：在 `app.json` 中添加：
  ```json
  "networkTimeout": {
    "request": 30000,
    "uploadFile": 30000
  },
  "permission": {
    "scope.userLocation": {
      "desc": "你的位置信息将用于小程序位置接口的效果展示"
    }
  }
  ```

#### 2.2 处理跨域问题
确保后端已经配置了CORS，允许APP的域名访问：

在 `backend/config.py` 中配置：
```python
CORS_ORIGINS = ['*']  # 或具体的APP域名
```

### 3. 测试API调用

#### 3.1 测试健康检查
```bash
curl https://swordedge.com/health
```

#### 3.2 测试用户信息API
```bash
curl https://swordedge.com/api/user/info
```

### 4. APP中调用示例

```javascript
// 导入API
import { authAPI, analysisAPI } from '@/utils/api.js'

// 登录
const login = async () => {
  try {
    const result = await authAPI.login({
      username: 'test',
      password: 'test'
    })
    console.log('登录成功:', result)
  } catch (error) {
    console.error('登录失败:', error)
  }
}

// 上传视频
const uploadVideo = async (filePath) => {
  try {
    const result = await analysisAPI.startAnalysis(filePath, {}, (progress) => {
      console.log('上传进度:', progress)
    })
    console.log('上传成功:', result)
  } catch (error) {
    console.error('上传失败:', error)
  }
}
```

## 四、常见问题及解决方案

### 1. 服务启动失败
- 检查日志文件：`tail -f /var/log/swordedge/error.log`
- 确保端口5001未被占用：`netstat -tuln | grep 5001`

### 2. 视频分析慢
- 考虑使用GPU加速
- 优化视频分析算法
- 增加服务器配置

### 3. SSL证书问题
- 检查证书有效期：`certbot certificates`
- 重新获取证书：`certbot renew`

### 4. APP无法访问API
- 检查域名解析：`nslookup swordedge.com`
- 检查SSL配置：`curl -v https://swordedge.com`
- 检查CORS配置

## 五、监控和维护

### 1. 监控服务状态
```bash
# 查看服务日志
journalctl -u swordedge -f

# 查看API访问日志
tail -f /var/log/swordedge/access.log
```

### 2. 更新代码
```bash
cd /opt/swordedge
git pull origin main
systemctl restart swordedge
```

### 3. 备份数据
```bash
# 备份数据库（如果有）
# 备份分析结果
cp -r /opt/swordedge/backend/static/reports /backup/
```

## 六、安全建议

1. **使用HTTPS**：确保所有API调用都使用HTTPS
2. **添加认证机制**：使用JWT token进行API认证
3. **限制IP访问**：在Nginx中配置IP白名单
4. **定期更新依赖**：定期运行 `pip install --upgrade -r requirements.txt`
5. **使用防火墙**：配置ufw或iptables限制端口访问

```bash
# 配置UFW防火墙
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

通过以上步骤，你可以成功将后端服务部署到公网，并在APP中调用后端API。

## 七、后端蓝图（Blueprints）与路由清单

后端已将路由模块化为 Flask 蓝图并统一挂载到 `/api` 前缀下（入口见 `backend/app.py` 中的蓝图注册）。下面列出当前已注册的蓝图与常用路由，供前端联调与运维测试使用：

- **认证：`backend/routes/auth.py` -> 挂载前缀 `/api`**
  - POST /api/login  -> 登录（body: {username,password}）
  - POST /api/register
  - POST /api/logout
  - GET  /api/user/info
  - POST /api/user/update

- **分析任务：`backend/routes/analysis.py` -> 挂载前缀 `/api`**
  - POST /api/start_analysis            -> 上传视频并启动异步分析（form field: `video`）
  - GET  /api/analysis_status/<id>     -> 查询分析任务状态与结果
  - POST /api/generate_skeleton_video  -> 生成骨架视频（body: {session_id})
  - POST /api/analyze_frame            -> 上传单帧图片（form field: `frame`）并返回关键点/评分
  - POST /api/get_coach_feedback       -> 获取 AI 教练反馈（body: action 数据）
  - GET  /api/reports/<path>           -> 访问生成的报告与视频（静态文件）

- **训练计划：`backend/routes/plan.py` -> 挂载前缀 `/api`**
  - GET  /api/plans/list
  - GET  /api/plans/detail/<id>
  - POST /api/plans/create
  - POST /api/plans/progress/<id>

- **训练记录：`backend/routes/training.py` -> 挂载前缀 `/api`**
  - GET  /api/training/list
  - GET  /api/training/detail/<id>
  - POST /api/training/delete/<id>
  - GET  /api/training/stats

- **实时/Socket：**
  - Flask-SocketIO 在主进程中运行，连接地址：`ws://<host>:5001` 或 `wss://<host>`（通过 Nginx TLS 代理时）
  - 事件：`frame`（服务器向客户端广播帧数据），`calibrate_ack`（校准确认）

说明：路由以 `/api` 为统一前缀；如果需要保留旧路径兼容，请在 `backend/app.py` 中调整（当前已移除兼容重定向）。

常用联调示例：

- 查询训练列表：
```bash
curl http://localhost:5001/api/training/list
```

- 上传视频并启动分析（示例，Linux/macOS curl）：
```bash
curl -X POST "http://localhost:5001/api/start_analysis" \
  -F "video=@/path/to/sample.mp4"
```

- 轮询分析状态：
```bash
curl http://localhost:5001/api/analysis_status/<session_id>
```

- 获取用户信息：
```bash
curl http://localhost:5001/api/user/info
```

若需通过 SocketIO 测试实时帧流，可使用 `socket.io-client` 在 Node/浏览器中连接并监听 `frame` 事件。示例（Node）:
```javascript
const io = require('socket.io-client');
const socket = io('http://localhost:5001');
socket.on('connect', () => console.log('connected'));
socket.on('frame', (data) => console.log('frame', data));
```